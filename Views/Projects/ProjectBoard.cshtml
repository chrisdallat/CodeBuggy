@using CodeBuggy.Controllers
@using CodeBuggy.Data
@using CodeBuggy.Helpers
@using CodeBuggy.Models.Projects
@using System.Text.Json
@using System.Web.Helpers
@using Microsoft.AspNetCore.Html

<script type="text/javascript" src="~/js/projectBoard.js"></script>

@model ProjectBoardModel

@{
    Func<IHtmlContent> RenderProjectTicketStatusDropdownList = () =>
    {
        var enumValues = Enum.GetValues(typeof(TicketStatus)).Cast<TicketStatus>();
        var options = enumValues.Select(e => $"<option value='{e}'>{e}</option>");
        var dropdownHtml = $@"
                <select name='Input.TicketStatusValue' class='form-control'>
            {string.Join("", options)}
                </select>";
        return new HtmlString(dropdownHtml);
    };

    Func<IHtmlContent> RenderProjectTicketPriorityDropdownList = () =>
    {
        var enumValues = Enum.GetValues(typeof(TicketPriority)).Cast<TicketPriority>();
        var options = enumValues.Select(e => $"<option value='{e}'>{e}</option>");
        var dropdownHtml = $@"
                <select name='Input.TicketPriorityValue' class='form-control'>
            {string.Join("", options)}
                </select>";
        return new HtmlString(dropdownHtml);
    };
}
@if (ViewBag.DeniedAccess == false)
{
    <div style="display: flex; justify-content: space-between; align-items: center;">
       
        <h2 style="text-align: center; flex: 1; margin-left: 200px;">@ViewBag.ProjectTitle</h2>
        <a class="create-button" style="text-align: left; margin-right: 10px;" asp-controller="Burndown" asp-action="Index"
           asp-route-projectId="@ViewBag.ProjectId">
            <span class="material-symbols-outlined" style="margin-right: 5px;">
                query_stats
            </span>
        </a>
        <a class="create-button" style="text-align: right;" onclick="showPopup('addTicketPopup')">
            <span class="material-symbols-outlined">
                add
            </span>
        </a>
    </div>

    <div class="board">
        <div class="column" id="todoColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3 class="column-title">To Do</h3>
            <div class="tickets-container">
                @Html.RenderTickets(Model.Tickets, TicketStatus.ToDo)
            </div>
        </div>
        <div class="column" id="inProgressColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3 class="column-title">In Progress</h3>
            <div class="tickets-container">
                @Html.RenderTickets(Model.Tickets, TicketStatus.InProgress)
            </div>
        </div>
        <div class="column" id="reviewColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3 class="column-title">Review</h3>
            <div class="tickets-container">
                @Html.RenderTickets(Model.Tickets, TicketStatus.Review)
            </div>
        </div>
        <div class="column" id="doneColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3 class="column-title">Done</h3>
            <div class="tickets-container">
                @Html.RenderTickets(Model.Tickets, TicketStatus.Done)
            </div>
        </div>
    </div>
}
else
{
    <div>Access Denied: This page does not exist</div>
}

@****************************************************************@
@************************* Dynamic Code *************************@
@****************************************************************@
@{
    string addTicketForm = $@"
        <form id='addTicketForm' action='AddTicket' method='post'>";

    string editTicketForm = $@"
        <form id='editTicketForm' action='editTicket' method='post'>";

    string ticketTitleInput = @"
            <div id='ticketTitleInput' class='form-floating mb-3' style='max-width: 380px'>
            <input name='Input.TicketTitle' class='form-control' autocomplete='TicketTitle' aria-required='true' placeholder='sadasdsaadsas'/>
            <label name='Input.TicketTitle'>Title</label>
        </div>";

    string ticketPriorityDropdown = $@"
        <div id='ticketPriority' class='form-floating mb-3 position-relative' style='max-width: 380px'>
            {RenderProjectTicketPriorityDropdownList()}
            <label name='Input.TicketPriorityValue'>Priority</label>
            <div class='dropdown-arrow'>▼</div>
        </div>";

    string ticketStatusDropdown = $@"
        <div id='ticketStatus' class='form-floating mb-3 position-relative' style='max-width: 380px'>
            {RenderProjectTicketStatusDropdownList()}
            <label name='Input.TicketStatusValue'>Status</label>
            <div class='dropdown-arrow'>▼</div>
        </div>";

    string ticketDescriptionInput = @"
        <div id='ticketDescriptionInput' class='form-floating mb-3' style='max-width: 380px'>
            <textarea id='codeEditor' name='Input.TicketDescription' class='form-control'
                        autocomplete='TicketDescription' aria-required='true'
                        placeholder='' style='resize: none; max-width: 100%; height: 150px; overflow-y: auto;'
                        maxlength='5000'></textarea>
            <label name='Input.TicketDescription'>Description</label>
        </div>";

    string projectIdDOM = $@"<input type='hidden' name='projectId' value='{@ViewBag.ProjectId}' />";

    string submitButton = @"
        <button id='submitButton' type='submit' class='button-general mb-3 mt-5'
            style='text-align: center; max-width: 160px'>
            Create Ticket
        </button>";

    var addTicketFormDOM = addTicketForm + ticketTitleInput + @Html.Raw(ticketPriorityDropdown) + @Html.Raw(ticketStatusDropdown) + ticketDescriptionInput + projectIdDOM + submitButton + "</form>";
    var addTicketPopup = new Popup();
    var addTicketPopupHTML = addTicketPopup.CreatePopup("addTicketPopup", "Add Ticket", new string[] { addTicketFormDOM });
    @Html.Raw(addTicketPopupHTML)

    var editTicketDOM = editTicketForm + ticketTitleInput + @Html.Raw(ticketPriorityDropdown) + @Html.Raw(ticketStatusDropdown) + ticketDescriptionInput + projectIdDOM + submitButton + "</form>";
    var editTicketPopup = new Popup();
    var editTicketPopupHTML = editTicketPopup.CreatePopup("editTicketPopup", "", new string[] { editTicketDOM });
    @Html.Raw(editTicketPopupHTML)
}
 

